<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Prompter V2 Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root {
            --accent: #00ff88;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --pad-bg: #2a2a2a;
            --error: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        .icon { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }

        /* --- SETUP SCREEN --- */
        .setup {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: var(--bg);
            z-index: 1000;
            position: absolute;
            width: 100%;
            transition: opacity 0.3s;
        }

        .setup h1 { font-size: 2.5rem; letter-spacing: 5px; margin-bottom: 2rem; color: var(--accent); }
        
        .mode-select { display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%; max-width: 300px; }
        
        .big-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            width: 100%;
            text-align: center;
        }
        
        .big-btn:active { background: var(--accent); color: var(--bg); transform: scale(0.98); }

        .input-group {
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .code-input {
            background: var(--surface);
            border: 1px solid #444;
            color: #fff;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 8px;
            letter-spacing: 5px;
            outline: none;
        }
        .code-input:focus { border-color: var(--accent); }

        .status { margin-top: 20px; color: #666; letter-spacing: 2px; font-size: 0.9rem; min-height: 20px; text-align: center;}
        .status.error { color: var(--error); }

        /* --- DISPLAY SCREEN --- */
        #displayView {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            touch-action: pan-y;
        }

        #prompterContent {
            padding: 0 10vw;
            font-size: 5rem;
            line-height: 1.6;
            transform: translateY(45vh);
            will-change: transform;
            text-align: left;
            white-space: pre-wrap;
            font-weight: bold;
            transform-origin: center center;
            letter-spacing: 0.05em;
            word-spacing: 0.1em;
        }

        .marker-line {
            position: fixed; top: 45%; left: 0; width: 100%; height: 0;
            border-top: 2px dashed rgba(255, 0, 0, 0.5); z-index: 50; pointer-events: none;
        }
        
        .triangle-marker {
            position: fixed; top: 45%; left: 20px; width: 0; height: 0;
            border-top: 15px solid transparent; border-bottom: 15px solid transparent;
            border-left: 20px solid rgba(255,0,0,0.7); transform: translateY(-50%); pointer-events: none;
        }

        .progress-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 4px;
            background: rgba(255,255,255,0.1); z-index: 100; pointer-events: none;
        }

        .progress-fill {
            height: 100%; background: var(--accent); width: 0%; transition: width 0.1s;
        }

        .overlay-ui {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px; flex-direction: column; align-items: flex-end;
        }

        .room-code-display {
            background: rgba(0,0,0,0.7);
            color: var(--accent);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--accent);
            font-family: monospace;
            font-size: 1.2rem;
        }

        /* Slide Mode Display */
        #slideContent {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            padding: 5vw;
            font-size: 4rem;
            line-height: 1.5;
            text-align: center;
            justify-content: center;
            align-items: center;
            white-space: pre-wrap;
            font-weight: bold;
        }

        .slide-nav {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: none;
            gap: 20px;
            z-index: 100;
        }

        .slide-nav button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(0,255,136,0.2);
            border: 2px solid var(--accent);
            color: var(--accent);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .slide-counter {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: var(--accent);
            padding: 10px 20px;
            border-radius: 4px;
            display: none;
            font-size: 1.2rem;
        }

        /* --- CONTROLLER SCREEN --- */
        #controllerView {
            display: none;
            flex-direction: column;
            height: 100%;
            background: var(--bg);
        }

        .top-bar {
            padding: 10px;
            background: var(--surface);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #333;
        }

        .text-preview {
            flex: 1;
            background: #000;
            border: 1px solid #444;
            padding: 10px;
            color: #aaa;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .edit-btn {
            background: var(--accent);
            border: none;
            border-radius: 4px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            cursor: pointer;
        }

        .toolbar {
            background: var(--surface);
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            border-bottom: 1px solid #333;
        }

        .pad-container {
            flex-grow: 1;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #scrollPad {
            width: 90%;
            height: 90%;
            background: var(--pad-bg);
            border-radius: 12px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 2px solid #444;
            touch-action: none;
        }

        .pad-instruction {
            color: rgba(255,255,255,0.2);
            font-weight: bold;
            text-align: center;
            pointer-events: none;
            line-height: 1.5;
        }

        #stickBase {
            position: absolute;
            width: 1px;
            height: 100%;
            background: rgba(255,255,255,0.1);
            display: none;
        }
        
        #stickHead {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
        }

        /* Slide Mode Controller */
        #slideControls {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 30px;
            height: 100%;
        }

        .slide-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: #000;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .slide-btn:active {
            transform: scale(0.95);
        }

        .slide-info {
            color: #aaa;
            font-size: 1.2rem;
            text-align: center;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid #444;
            border-radius: 8px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .tool-btn:active { background: #444; }
        .tool-btn.active { background: var(--accent); color: #000; border: none; }

        /* --- EDIT MODAL --- */
        #editModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 2000;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 15px;
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .save-btn {
            background: var(--accent);
            color: #000;
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        .editor-toolbar {
            background: var(--surface);
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            border-bottom: 1px solid #333;
        }

        .editor-toolbar .tool-btn {
            height: 40px;
        }

        #fullTextInput {
            flex: 1;
            background: #121212;
            color: #fff;
            padding: 20px;
            font-size: 18px;
            border: none;
            resize: none;
            outline: none;
            font-family: monospace;
        }

        .format-panel {
            background: var(--surface);
            padding: 15px;
            border-top: 1px solid #333;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .format-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .format-row label {
            font-size: 0.85rem;
            color: #aaa;
            min-width: 80px;
        }

        .format-row input,
        .format-row select {
            flex: 1;
            background: #000;
            border: 1px solid #444;
            color: #fff;
            padding: 8px;
            border-radius: 4px;
            outline: none;
        }

        .format-row input:focus,
        .format-row select:focus {
            border-color: var(--accent);
        }

    </style>
</head>
<body>

    <div class="setup" id="setupView">
        <h1>PROMPTER</h1>
        
        <div class="mode-select" id="initialBtns">
            <button class="big-btn" onclick="startDisplay()">I AM THE SCREEN</button>
            <button class="big-btn" onclick="showRemoteInput()">I AM THE REMOTE</button>
        </div>

        <div class="mode-select input-group" id="remoteInputGroup">
            <input type="number" id="roomCodeInput" class="code-input" placeholder="0000" pattern="\d*">
            <button class="big-btn" onclick="connectToDisplay()">CONNECT</button>
            <button class="big-btn" style="border-color: #444; color: #888; font-size: 0.9rem;" onclick="backToMain()">BACK</button>
        </div>

        <div class="status" id="statusText">Select Mode</div>
    </div>

    <div id="displayView">
        <div class="marker-line"></div>
        <div class="triangle-marker"></div>
        
        <div class="overlay-ui" id="displayUI">
            <div class="room-code-display" id="displayCodeBox">CODE: ----</div>
            <button class="big-btn" style="font-size: 0.8rem; padding: 8px;" onclick="toggleLocalFullscreen()">FULLSCREEN</button>
        </div>

        <div id="prompterContent">
            Waiting for connection...
            1. Open Prompter on phone
            2. Select 'I AM THE REMOTE'
            3. Enter code above
        </div>

        <div id="slideContent"></div>
        
        <div class="slide-counter" id="slideCounter">1 / 1</div>
        
        <div class="slide-nav" id="slideNav">
            <button onclick="prevSlide()">◀</button>
            <button onclick="nextSlide()">▶</button>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>

    <div id="controllerView">
        <div class="top-bar">
            <div class="text-preview" id="textPreview" onclick="openEditor()">Tap to edit script...</div>
            <button class="edit-btn" onclick="openEditor()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
        </div>

        <div class="toolbar">
            <button class="tool-btn" onclick="sendAction('reset')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
            </button>
            
            <button class="tool-btn" onclick="toggleMirror()" id="mirrorBtn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
            </button>

            <button class="tool-btn" onclick="sendAction('sync')" style="color: var(--accent)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
            </button>
            
            <button class="tool-btn" onclick="cycleColor()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg>
            </button>

            <button class="tool-btn" onclick="sendAction('hideUI')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            </button>
        </div>

        <div class="pad-container">
            <div id="scrollPad">
                <div class="pad-instruction">
                    TOUCH & HOLD TO SCROLL<br>
                    <span style="font-size:0.8em; font-weight:normal; opacity:0.7">PINCH TO RESIZE TEXT</span>
                </div>
                <div id="stickBase"></div>
                <div id="stickHead"></div>
            </div>

            <div id="slideControls">
                <div class="slide-info" id="slideInfo">Slide 1 / 1</div>
                <button class="slide-btn" onclick="remotePrevSlide()">◀</button>
                <button class="slide-btn" onclick="remoteNextSlide()">▶</button>
            </div>
        </div>
    </div>

    <div id="editModal">
        <div class="modal-header">
            <span>Edit Script</span>
            <button class="save-btn" onclick="closeEditor()">DONE</button>
        </div>

        <div class="editor-toolbar">
            <button class="tool-btn" onclick="clearText()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
                CLEAR
            </button>
            
            <button class="tool-btn" onclick="copyText()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                COPY
            </button>
            
            <button class="tool-btn" onclick="pasteText()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"/></svg>
                PASTE
            </button>

            <button class="tool-btn" onclick="toggleMode()" id="modeToggle">
                <svg class="icon" viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM3 19V5h8v14H3zm18 0h-8V5h8v14z"/></svg>
                SLIDE
            </button>
        </div>

        <textarea id="fullTextInput" placeholder="Type your text here...">Welcome to Pro Prompter.

This is a demonstration script.

1. Use the large pad on the Remote to scroll.
   - Slide UP to scroll down.
   - The further you slide, the faster it goes.
2. Pinch on the pad to change text size.
3. Tap "Edit" on the remote to change this text.

Happy Recording!</textarea>

        <div class="format-panel">
            <div class="format-row">
                <label>Font Size:</label>
                <input type="range" id="fontSizeSlider" min="2" max="10" step="0.5" value="5" oninput="updateFontSize(this.value)">
            </div>
            
            <div class="format-row">
                <label>Alignment:</label>
                <select id="alignSelect" onchange="updateAlignment(this.value)">
                    <option value="left">Left</option>
                    <option value="center">Center</option>
                    <option value="right">Right</option>
                    <option value="justify">Justify</option>
                </select>
            </div>
            
            <div class="format-row">
                <label>Letter Space:</label>
                <input type="range" id="letterSpaceSlider" min="0" max="0.5" step="0.01" value="0.05" oninput="updateLetterSpacing(this.value)">
            </div>
            
            <div class="format-row">
                <label>Word Space:</label>
                <input type="range" id="wordSpaceSlider" min="0" max="0.5" step="0.01" value="0.1" oninput="updateWordSpacing(this.value)">
            </div>
            
            <div class="format-row">
                <label>Line Height:</label>
                <input type="range" id="lineHeightSlider" min="1" max="3" step="0.1" value="1.6" oninput="updateLineHeight(this.value)">
            </div>
            
            <div class="format-row">
                <label>Font Weight:</label>
                <select id="fontWeightSelect" onchange="updateFontWeight(this.value)">
                    <option value="normal">Normal</option>
                    <option value="bold" selected>Bold</option>
                    <option value="lighter">Light</option>
                </select>
            </div>
        </div>
    </div>

    <script>
        const ID_PREFIX = "PROMPTER-V2-";

        let peer, conn;
        let mode = '';
        let myRoomCode = '';
        let heartbeatInterval;
        let wakeLock = null;

        // Display State
        let scrollY = 0;
        let speed = 0;
        let isMirrored = false;
        let fontSize = 5;
        let isUIHidden = false;
        let textAlign = 'left';
        let letterSpacing = 0.05;
        let wordSpacing = 0.1;
        let lineHeight = 1.6;
        let fontWeight = 'bold';
        let displayMode = 'scroll'; // 'scroll' or 'slide'
        let slides = [];
        let currentSlide = 0;

        // Controller State
        let touchStartY = 0;
        let isTouching = false;
        let pinchDistStart = 0;
        let tempFontSize = 5;

        // Display touch scroll
        let displayTouchStartY = 0;
        let displayTouching = false;

        function setStatus(msg, isError = false) {
            const el = document.getElementById('statusText');
            el.innerText = msg;
            el.className = isError ? "status error" : "status";
        }

        function backToMain() {
            document.getElementById('initialBtns').style.display = 'flex';
            document.getElementById('remoteInputGroup').style.display = 'none';
            setStatus("Select Mode");
        }

        function showRemoteInput() {
            document.getElementById('initialBtns').style.display = 'none';
            document.getElementById('remoteInputGroup').style.display = 'flex';
            document.getElementById('roomCodeInput').focus();
            setStatus("Enter the code from the Display screen");
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                    wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
                }
            } catch (err) {
                console.log(`${err.name}, ${err.message}`);
            }
        }

        function startDisplay() {
            mode = 'display';
            setStatus("Starting Display...");
            requestWakeLock();
            
            myRoomCode = Math.floor(1000 + Math.random() * 9000).toString();
            const fullId = ID_PREFIX + myRoomCode;

            document.getElementById('setupView').style.display = 'none';
            document.getElementById('displayView').style.display = 'block';
            document.getElementById('displayCodeBox').innerText = "CODE: " + myRoomCode;

            peer = new Peer(fullId);
            
            peer.on('open', (id) => {
                console.log('Host ID:', id);
            });

            peer.on('connection', (c) => {
                if(conn) { conn.close(); }
                
                conn = c;
                setStatus("Remote Connected!");
                
                conn.on('data', handleData);
                conn.on('close', () => {
                    setStatus("Remote Disconnected");
                    conn = null;
                });

                setTimeout(() => {
                    const currentText = document.getElementById('prompterContent').innerText;
                    if(conn && conn.open) {
                        conn.send({ 
                            type: 'syncAll',
                            text: currentText,
                            fontSize: fontSize,
                            align: textAlign,
                            letterSpacing: letterSpacing,
                            wordSpacing: wordSpacing,
                            lineHeight: lineHeight,
                            fontWeight: fontWeight,
                            mode: displayMode
                        });
                    }
                }, 500);
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    startDisplay(); 
                } else {
                    alert("Network Error: " + err.type);
                }
            });

            setupDisplayTouch();
            requestAnimationFrame(displayLoop);
        }

        function setupDisplayTouch() {
            const displayView = document.getElementById('displayView');
            
            displayView.addEventListener('touchstart', (e) => {
                if (displayMode === 'slide') return;
                displayTouching = true;
                displayTouchStartY = e.touches[0].clientY;
            }, { passive: true });

            displayView.addEventListener('touchmove', (e) => {
                if (displayMode === 'slide' || !displayTouching) return;
                const currentY = e.touches[0].clientY;
                const deltaY = displayTouchStartY - currentY;
                scrollY -= deltaY * 0.8;
                displayTouchStartY = currentY;
            }, { passive: true });

            displayView.addEventListener('touchend', () => {
                displayTouching = false;
            }, { passive: true });
        }

        function connectToDisplay() {
            const inputVal = document.getElementById('roomCodeInput').value;
            if (inputVal.length < 4) {
                setStatus("Please enter the 4-digit code", true);
                return;
            }

            mode = 'controller';
            setStatus("Connecting...");
            requestWakeLock();
            
            const targetId = ID_PREFIX + inputVal;
            
            peer = new Peer();

            peer.on('open', () => {
                conn = peer.connect(targetId, { reliable: true });
                setupConnectionHandlers();
            });

            peer.on('error', (err) => {
                setStatus("Error: " + err.type, true);
                if(err.type === 'peer-unavailable') {
                    setStatus("Display not found. Check code.", true);
                }
            });
        }

        function setupConnectionHandlers() {
            conn.on('open', () => {
                console.log("Connected to display");
                document.getElementById('setupView').style.display = 'none';
                document.getElementById('controllerView').style.display = 'flex';
                setupControllerEvents();
                sendAction('sync');
                startHeartbeat();
            });

            conn.on('data', (data) => {
                if (data.type === 'syncAll') {
                    document.getElementById('fullTextInput').value = data.text;
                    document.getElementById('fontSizeSlider').value = data.fontSize;
                    document.getElementById('alignSelect').value = data.align;
                    document.getElementById('letterSpaceSlider').value = data.letterSpacing;
                    document.getElementById('wordSpaceSlider').value = data.wordSpacing;
                    document.getElementById('lineHeightSlider').value = data.lineHeight;
                    document.getElementById('fontWeightSelect').value = data.fontWeight;
                    tempFontSize = data.fontSize;
                    if (data.mode === 'slide') {
                        displayMode = 'slide';
                        switchToSlideMode();
                    }
                    updateTextPreview();
                }
            });

            conn.on('close', () => {
                console.log("Connection lost");
                document.getElementById('textPreview').innerText = "DISCONNECTED - Reconnecting...";
                setTimeout(() => {
                   if(peer && !peer.destroyed) {
                        const targetId = conn.peer;
                        console.log("Reconnecting to " + targetId);
                        conn = peer.connect(targetId);
                        setupConnectionHandlers();
                   }
                }, 2000);
            });

            conn.on('error', (err) => console.error(err));
        }

        function startHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if(conn && conn.open) {
                    conn.send({ type: 'ping' });
                }
            }, 2000);
        }

        function sendData(data) {
            if (conn && conn.open) {
                conn.send(data);
            }
        }

        function handleData(data) {
            const content = document.getElementById('prompterContent');
            const slideContent = document.getElementById('slideContent');
            
            switch(data.type) {
                case 'speed':
                    speed = data.val;
                    break;
                case 'text':
                    content.innerText = data.val;
                    scrollY = 0;
                    if (displayMode === 'slide') {
                        updateSlides(data.val);
                    }
                    break;
                case 'fontSize':
                    fontSize = data.val;
                    content.style.fontSize = fontSize + 'rem';
                    slideContent.style.fontSize = fontSize + 'rem';
                    break;
                case 'align':
                    textAlign = data.val;
                    content.style.textAlign = textAlign;
                    slideContent.style.textAlign = textAlign;
                    break;
                case 'letterSpacing':
                    letterSpacing = data.val;
                    content.style.letterSpacing = letterSpacing + 'em';
                    slideContent.style.letterSpacing = letterSpacing + 'em';
                    break;
                case 'wordSpacing':
                    wordSpacing = data.val;
                    content.style.wordSpacing = wordSpacing + 'em';
                    slideContent.style.wordSpacing = wordSpacing + 'em';
                    break;
                case 'lineHeight':
                    lineHeight = data.val;
                    content.style.lineHeight = lineHeight;
                    slideContent.style.lineHeight = lineHeight;
                    break;
                case 'fontWeight':
                    fontWeight = data.val;
                    content.style.fontWeight = fontWeight;
                    slideContent.style.fontWeight = fontWeight;
                    break;
                case 'reset':
                    scrollY = 0;
                    speed = 0;
                    currentSlide = 0;
                    if (displayMode === 'slide') showSlide(0);
                    break;
                case 'mirror':
                    isMirrored = !isMirrored;
                    updateTransform();
                    content.style.textAlign = isMirrored ? 'right' : textAlign;
                    break;
                case 'color':
                    const colors = ['#ffffff', '#ffff00', '#00ff00', '#00ffff'];
                    let curr = colors.indexOf(content.style.color || '#ffffff');
                    const newColor = colors[(curr + 1) % colors.length];
                    content.style.color = newColor;
                    slideContent.style.color = newColor;
                    break;
                case 'hideUI':
                    isUIHidden = !isUIHidden;
                    const opacity = isUIHidden ? '0' : '1';
                    document.getElementById('displayUI').style.opacity = opacity;
                    document.querySelector('.marker-line').style.opacity = opacity;
                    document.querySelector('.triangle-marker').style.opacity = opacity;
                    document.getElementById('slideCounter').style.opacity = opacity;
                    document.getElementById('progressFill').parentElement.style.opacity = opacity;
                    document.body.style.cursor = isUIHidden ? 'none' : 'default';
                    break;
                case 'sync':
                    conn.send({ 
                        type: 'syncAll',
                        text: content.innerText,
                        fontSize: fontSize,
                        align: textAlign,
                        letterSpacing: letterSpacing,
                        wordSpacing: wordSpacing,
                        lineHeight: lineHeight,
                        fontWeight: fontWeight,
                        mode: displayMode
                    });
                    break;
                case 'mode':
                    displayMode = data.val;
                    if (displayMode === 'slide') {
                        document.getElementById('prompterContent').style.display = 'none';
                        document.getElementById('slideContent').style.display = 'flex';
                        document.querySelector('.marker-line').style.display = 'none';
                        document.querySelector('.triangle-marker').style.display = 'none';
                        document.getElementById('slideCounter').style.display = 'block';
                        document.getElementById('slideNav').style.display = 'flex';
                        updateSlides(content.innerText);
                        showSlide(0);
                    } else {
                        document.getElementById('prompterContent').style.display = 'block';
                        document.getElementById('slideContent').style.display = 'none';
                        document.querySelector('.marker-line').style.display = 'block';
                        document.querySelector('.triangle-marker').style.display = 'block';
                        document.getElementById('slideCounter').style.display = 'none';
                        document.getElementById('slideNav').style.display = 'none';
                    }
                    break;
                case 'nextSlide':
                    if (currentSlide < slides.length - 1) {
                        currentSlide++;
                        showSlide(currentSlide);
                    }
                    break;
                case 'prevSlide':
                    if (currentSlide > 0) {
                        currentSlide--;
                        showSlide(currentSlide);
                    }
                    break;
                case 'ping':
                    break;
            }
        }

        function updateSlides(text) {
            slides = text.split(/\n\n+/).filter(s => s.trim());
            currentSlide = 0;
            showSlide(0);
        }

        function showSlide(index) {
            if (slides.length === 0) return;
            const slideContent = document.getElementById('slideContent');
            slideContent.innerText = slides[index] || '';
            document.getElementById('slideCounter').innerText = `${index + 1} / ${slides.length}`;
            updateProgress();
        }

        function nextSlide() {
            if (currentSlide < slides.length - 1) {
                currentSlide++;
                showSlide(currentSlide);
            }
        }

        function prevSlide() {
            if (currentSlide > 0) {
                currentSlide--;
                showSlide(currentSlide);
            }
        }

        function displayLoop() {
            if (displayMode === 'scroll') {
                if (Math.abs(speed) > 0.1) {
                    scrollY -= speed;
                }
                updateTransform();
                updateProgress();
            }
            requestAnimationFrame(displayLoop);
        }

        function updateProgress() {
            const progressFill = document.getElementById('progressFill');
            if (displayMode === 'slide') {
                const progress = slides.length > 0 ? ((currentSlide + 1) / slides.length) * 100 : 0;
                progressFill.style.width = progress + '%';
            } else {
                const content = document.getElementById('prompterContent');
                const totalHeight = content.scrollHeight;
                const viewHeight = window.innerHeight;
                const maxScroll = totalHeight - viewHeight * 0.55;
                const progress = maxScroll > 0 ? Math.max(0, Math.min(100, (-scrollY / maxScroll) * 100)) : 0;
                progressFill.style.width = progress + '%';
            }
        }

        function updateTransform() {
            const content = document.getElementById('prompterContent');
            const scale = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
            content.style.transform = `${scale} translateY(${scrollY}px)`;
        }

        function toggleLocalFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        function setupControllerEvents() {
            const pad = document.getElementById('scrollPad');
            const stickHead = document.getElementById('stickHead');
            const stickBase = document.getElementById('stickBase');

            pad.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    isTouching = false;
                    pinchDistStart = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    return;
                }

                isTouching = true;
                touchStartY = e.touches[0].clientY;
                
                const rect = pad.getBoundingClientRect();
                const relativeY = e.touches[0].clientY - rect.top;
                
                stickBase.style.display = 'block';
                stickBase.style.top = relativeY + 'px';
                stickHead.style.display = 'block';
                stickHead.style.top = relativeY + 'px';
            }, { passive: false });

            pad.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const delta = dist - pinchDistStart;
                    if (Math.abs(delta) > 10) {
                        if (delta > 0) tempFontSize += 0.1;
                        else tempFontSize = Math.max(1, tempFontSize - 0.1);
                        sendData({ type: 'fontSize', val: tempFontSize });
                        pinchDistStart = dist;
                    }
                    return;
                }

                if (!isTouching) return;

                const currentY = e.touches[0].clientY;
                const deltaY = touchStartY - currentY;
                let scrollSpeed = deltaY * 0.15;
                
                if (scrollSpeed > 25) scrollSpeed = 25;
                if (scrollSpeed < -25) scrollSpeed = -25;

                sendData({ type: 'speed', val: scrollSpeed });

                let visualOffset = -deltaY;
                if(visualOffset > 40) visualOffset = 40;
                if(visualOffset < -40) visualOffset = -40;
                stickHead.style.transform = `translate(-50%, calc(-50% + ${visualOffset}px))`;
            }, { passive: false });

            pad.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (e.touches.length === 0) {
                    isTouching = false;
                    sendData({ type: 'speed', val: 0 });
                    stickHead.style.display = 'none';
                    stickBase.style.display = 'none';
                    stickHead.style.transform = `translate(-50%, -50%)`;
                }
            });
        }

        function openEditor() {
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function closeEditor() {
            document.getElementById('editModal').style.display = 'none';
            const text = document.getElementById('fullTextInput').value;
            updateTextPreview();
            sendData({ type: 'text', val: text });
        }

        function updateTextPreview() {
            const text = document.getElementById('fullTextInput').value;
            const preview = text.split('\n')[0] || "No text...";
            document.getElementById('textPreview').innerText = preview;
        }

        function clearText() {
            if (confirm('Clear all text?')) {
                document.getElementById('fullTextInput').value = '';
            }
        }

        async function copyText() {
            const text = document.getElementById('fullTextInput').value;
            try {
                await navigator.clipboard.writeText(text);
                alert('Text copied!');
            } catch (err) {
                alert('Failed to copy text');
            }
        }

        async function pasteText() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('fullTextInput').value = text;
            } catch (err) {
                alert('Failed to paste text');
            }
        }

        function toggleMode() {
            displayMode = displayMode === 'scroll' ? 'slide' : 'scroll';
            const btn = document.getElementById('modeToggle');
            btn.innerHTML = displayMode === 'slide' ? 
                '<svg class="icon" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>SCROLL' :
                '<svg class="icon" viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM3 19V5h8v14H3zm18 0h-8V5h8v14z"/></svg>SLIDE';
            
            sendData({ type: 'mode', val: displayMode });
            
            if (displayMode === 'slide') {
                switchToSlideMode();
            } else {
                switchToScrollMode();
            }
        }

        function switchToSlideMode() {
            document.getElementById('scrollPad').style.display = 'none';
            document.getElementById('slideControls').style.display = 'flex';
            const text = document.getElementById('fullTextInput').value;
            const localSlides = text.split(/\n\n+/).filter(s => s.trim());
            document.getElementById('slideInfo').innerText = `Slide 1 / ${localSlides.length}`;
        }

        function switchToScrollMode() {
            document.getElementById('scrollPad').style.display = 'flex';
            document.getElementById('slideControls').style.display = 'none';
        }

        function remoteNextSlide() {
            sendData({ type: 'nextSlide' });
            const text = document.getElementById('fullTextInput').value;
            const localSlides = text.split(/\n\n+/).filter(s => s.trim());
            const nextSlide = Math.min(currentSlide + 1, localSlides.length - 1);
            document.getElementById('slideInfo').innerText = `Slide ${nextSlide + 1} / ${localSlides.length}`;
            currentSlide = nextSlide;
        }

        function remotePrevSlide() {
            sendData({ type: 'prevSlide' });
            const text = document.getElementById('fullTextInput').value;
            const localSlides = text.split(/\n\n+/).filter(s => s.trim());
            const prevSlideNum = Math.max(currentSlide - 1, 0);
            document.getElementById('slideInfo').innerText = `Slide ${prevSlideNum + 1} / ${localSlides.length}`;
            currentSlide = prevSlideNum;
        }

        function updateFontSize(val) {
            sendData({ type: 'fontSize', val: parseFloat(val) });
        }

        function updateAlignment(val) {
            sendData({ type: 'align', val: val });
        }

        function updateLetterSpacing(val) {
            sendData({ type: 'letterSpacing', val: parseFloat(val) });
        }

        function updateWordSpacing(val) {
            sendData({ type: 'wordSpacing', val: parseFloat(val) });
        }

        function updateLineHeight(val) {
            sendData({ type: 'lineHeight', val: parseFloat(val) });
        }

        function updateFontWeight(val) {
            sendData({ type: 'fontWeight', val: val });
        }

        function sendAction(actionType) {
            if (actionType === 'mirror') {
                document.getElementById('mirrorBtn').classList.toggle('active');
            }
            sendData({ type: actionType });
        }

        function cycleColor() { sendData({ type: 'color' }); }
        function toggleMirror() { sendAction('mirror'); }

        document.addEventListener('contextmenu', event => event.preventDefault());

        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

    </script>
</body>
</html>