<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Prompter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root {
            --accent: #00ff88;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --pad-bg: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none; /* Prevents default browser zooming/scrolling */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- ICONS (SVG) --- */
        .icon { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }

        /* --- SETUP SCREEN --- */
        .setup {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: var(--bg);
            z-index: 1000;
            position: absolute;
            width: 100%;
        }

        .setup h1 { font-size: 2.5rem; letter-spacing: 5px; margin-bottom: 2rem; color: var(--accent); }
        
        .btn-group { display: flex; gap: 20px; }
        
        .big-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }
        
        .big-btn:active { background: var(--accent); color: var(--bg); }
        .status { margin-top: 20px; color: #666; letter-spacing: 2px; }

        /* --- DISPLAY SCREEN --- */
        #displayView {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
        }

        #prompterContent {
            padding: 0 10vw; /* Horizontal padding */
            font-size: 5rem;
            line-height: 1.6;
            transform: translateY(45vh); /* Start in middle */
            will-change: transform;
            text-align: left;
            white-space: pre-wrap;
            font-weight: bold;
            transform-origin: center center;
        }

        .marker-line {
            position: fixed;
            top: 45%;
            left: 0; width: 100%;
            height: 0;
            border-top: 2px dashed rgba(255, 0, 0, 0.5);
            z-index: 50;
        }
        
        .triangle-marker {
            position: fixed;
            top: 45%;
            left: 20px;
            width: 0; height: 0;
            border-top: 15px solid transparent;
            border-bottom: 15px solid transparent;
            border-left: 20px solid rgba(255,0,0,0.7);
            transform: translateY(-50%);
        }

        .overlay-ui {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 100;
            transition: opacity 0.3s;
        }

        /* --- CONTROLLER SCREEN --- */
        #controllerView {
            display: none;
            flex-direction: column;
            height: 100%;
            background: var(--bg);
        }

        /* Top Bar: Input & Edit */
        .top-bar {
            padding: 15px;
            background: var(--surface);
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #333;
        }

        .text-preview {
            flex: 1;
            background: #000;
            border: 1px solid #444;
            padding: 10px;
            color: #aaa;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
        }

        .edit-btn {
            background: var(--accent);
            border: none;
            border-radius: 4px;
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            color: #000;
        }

        /* Scroll Pad Area */
        .pad-container {
            flex-grow: 1;
            position: relative;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #scrollPad {
            width: 90%;
            height: 90%;
            background: var(--pad-bg);
            border-radius: 12px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            border: 2px solid #444;
            touch-action: none;
        }

        .pad-instruction {
            color: rgba(255,255,255,0.2);
            font-weight: bold;
            text-align: center;
            pointer-events: none;
            line-height: 1.5;
        }

        /* Visual feedback for joystick */
        #stickBase {
            position: absolute;
            width: 1px; height: 100%;
            background: rgba(255,255,255,0.1);
            display: none; /* Shown on touch */
        }
        #stickHead {
            position: absolute;
            width: 80px; height: 80px;
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--accent);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            display: none;
            pointer-events: none;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            background: var(--surface);
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            border-top: 1px solid #333;
        }

        .tool-btn {
            background: transparent;
            border: 1px solid #444;
            border-radius: 8px;
            height: 50px;
            display: flex; align-items: center; justify-content: center;
            color: #fff;
        }
        .tool-btn:active { background: #444; }
        .tool-btn.active { background: var(--accent); color: #000; border: none; }

        /* Edit Modal */
        #editModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg);
            z-index: 2000;
            flex-direction: column;
        }
        
        #editModal textarea {
            flex: 1;
            background: #121212;
            color: #fff;
            padding: 20px;
            font-size: 18px;
            border: none;
            resize: none;
            outline: none;
        }
        
        .modal-header {
            padding: 15px;
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .save-btn {
            background: var(--accent);
            color: #000;
            padding: 8px 20px;
            border: none;
            border-radius: 4px;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div class="setup" id="setupView">
        <h1>PROMPTER</h1>
        <div class="btn-group">
            <button class="big-btn" onclick="initApp('display')">DISPLAY</button>
            <button class="big-btn" onclick="initApp('controller')">REMOTE</button>
        </div>
        <div class="status" id="statusText">Select Mode</div>
    </div>

    <div id="displayView">
        <div class="marker-line"></div>
        <div class="triangle-marker"></div>
        
        <div class="overlay-ui" id="displayUI">
            <button class="big-btn" style="font-size: 0.9rem; padding: 10px;" onclick="toggleLocalFullscreen()">FULLSCREEN</button>
        </div>

        <div id="prompterContent">
            Waiting for controller...
        </div>
    </div>

    <div id="controllerView">
        <div class="top-bar">
            <div class="text-preview" id="textPreview" onclick="openEditor()">Tap to edit script...</div>
            <button class="edit-btn" onclick="openEditor()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
        </div>

        <div class="pad-container">
            <div id="scrollPad">
                <div class="pad-instruction">
                    TOUCH & HOLD TO SCROLL<br>
                    <span style="font-size:0.8em; font-weight:normal; opacity:0.7">PINCH TO RESIZE TEXT</span>
                </div>
                <div id="stickBase"></div>
                <div id="stickHead"></div>
            </div>
        </div>

        <div class="bottom-toolbar">
            <button class="tool-btn" onclick="sendAction('reset')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
            </button>
            
            <button class="tool-btn" onclick="toggleMirror()" id="mirrorBtn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
            </button>

            <button class="tool-btn" onclick="sendAction('sync')" style="color: var(--accent)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
            </button>
            
            <button class="tool-btn" onclick="cycleColor()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg>
            </button>

            <button class="tool-btn" onclick="sendAction('hideUI')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            </button>
        </div>
    </div>

    <div id="editModal">
        <div class="modal-header">
            <span>Edit Script</span>
            <button class="save-btn" onclick="closeEditor()">DONE</button>
        </div>
        <textarea id="fullTextInput" placeholder="Type your text here...">Welcome to Pro Prompter.

This is a demonstration script.

1. Connect a second device as "Remote".
2. Use the large pad to scroll.
   - Slide UP to scroll down.
   - The further you slide, the faster it goes.
3. Pinch on the pad to change text size.
4. Press the Edit button to change this text.

Happy Recording!</textarea>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PEER_ID = "PROMPTER-HOST-2024"; // Simple fixed ID for demo purposes
        
        // --- GLOBAL STATE ---
        let peer, conn;
        let mode = ''; // 'display' or 'controller'
        
        // Display State
        let scrollY = 0;
        let speed = 0; // Pixels per frame
        let isMirrored = false;
        let fontSize = 5; // rem
        let isUIHidden = false;

        // Controller State
        let touchStartY = 0;
        let isTouching = false;
        let pinchDistStart = 0;
        let tempFontSize = 5;

        // --- INITIALIZATION ---
        function initApp(selectedMode) {
            mode = selectedMode;
            document.getElementById('setupView').style.display = 'none';
            document.getElementById('statusText').innerText = "Connecting...";

            if (mode === 'display') {
                document.getElementById('displayView').style.display = 'block';
                startPeerServer();
                requestAnimationFrame(displayLoop); // Start the animation loop
            } else {
                document.getElementById('controllerView').style.display = 'flex';
                startPeerClient();
                setupControllerEvents();
            }
        }

        // --- PEER JS NETWORKING ---
        function startPeerServer() {
            peer = new Peer(PEER_ID);
            peer.on('open', (id) => {
                console.log('Host ID:', id);
            });
            peer.on('connection', (c) => {
                conn = c;
                conn.on('data', handleData);
                // Send current text to new controller
                setTimeout(() => {
                    const currentText = document.getElementById('prompterContent').innerText;
                    conn.send({ type: 'syncText', text: currentText });
                }, 500);
            });
            peer.on('error', err => alert("ID taken or error. Try closing other tabs."));
        }

        function startPeerClient() {
            peer = new Peer(); // Random ID
            peer.on('open', () => {
                conn = peer.connect(PEER_ID);
                conn.on('open', () => {
                    console.log("Connected to display");
                    sendAction('sync'); // Request current text
                });
                conn.on('data', (data) => {
                    if (data.type === 'syncText') {
                        document.getElementById('fullTextInput').value = data.text;
                        updateTextPreview();
                    }
                });
                conn.on('error', () => alert("Could not find Display. Open Display first."));
            });
        }

        function sendData(data) {
            if (conn && conn.open) conn.send(data);
        }

        function handleData(data) {
            const content = document.getElementById('prompterContent');
            
            if (data.type === 'speed') {
                speed = data.val;
            } 
            else if (data.type === 'text') {
                content.innerText = data.val;
                scrollY = 0; // Reset scroll on new text
            } 
            else if (data.type === 'fontSize') {
                fontSize = data.val;
                content.style.fontSize = fontSize + 'rem';
            } 
            else if (data.type === 'reset') {
                scrollY = 0;
                speed = 0;
            }
            else if (data.type === 'mirror') {
                isMirrored = !isMirrored;
                content.style.transform = `scaleX(${isMirrored ? -1 : 1}) translateY(${scrollY}px)`;
                content.style.textAlign = isMirrored ? 'right' : 'left'; // Helps readability
            }
            else if (data.type === 'color') {
                const colors = ['#ffffff', '#ffff00', '#00ff00', '#00ffff'];
                let curr = colors.indexOf(content.style.color || '#ffffff');
                content.style.color = colors[(curr + 1) % colors.length];
            }
            else if (data.type === 'hideUI') {
                isUIHidden = !isUIHidden;
                document.getElementById('displayUI').style.opacity = isUIHidden ? '0' : '1';
                document.querySelector('.marker-line').style.opacity = isUIHidden ? '0' : '1';
                document.querySelector('.triangle-marker').style.opacity = isUIHidden ? '0' : '1';
                document.body.style.cursor = isUIHidden ? 'none' : 'default';
            }
            else if (data.type === 'sync') {
                // Controller requesting text
                conn.send({ type: 'syncText', text: content.innerText });
            }
        }

        // --- DISPLAY LOGIC (Animation Loop) ---
        function displayLoop() {
            if (Math.abs(speed) > 0.1) {
                // speed is pixels per frame. 
                // speed > 0 means finger moved UP, so text should scroll UP (reading forward)
                // In CSS translateY, negative is UP.
                scrollY -= speed; 
            }
            
            const content = document.getElementById('prompterContent');
            // Apply Transform
            const scale = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
            content.style.transform = `${scale} translateY(${scrollY}px)`;
            
            requestAnimationFrame(displayLoop);
        }

        function toggleLocalFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // --- CONTROLLER LOGIC ---
        function setupControllerEvents() {
            const pad = document.getElementById('scrollPad');
            const stickHead = document.getElementById('stickHead');
            const stickBase = document.getElementById('stickBase');

            pad.addEventListener('touchstart', (e) => {
                e.preventDefault();
                // Check if pinching (2 fingers)
                if (e.touches.length === 2) {
                    isTouching = false; // Disable scroll logic
                    pinchDistStart = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    return;
                }

                // Scroll Logic (1 finger)
                isTouching = true;
                touchStartY = e.touches[0].clientY;
                
                // Visuals
                const rect = pad.getBoundingClientRect();
                const relativeY = e.touches[0].clientY - rect.top;
                stickBase.style.display = 'block';
                stickBase.style.top = relativeY + 'px'; // Base stays at start point
                stickHead.style.display = 'block';
                stickHead.style.top = relativeY + 'px';
            }, { passive: false });

            pad.addEventListener('touchmove', (e) => {
                e.preventDefault();

                // Pinch Logic
                if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const delta = dist - pinchDistStart;
                    
                    // Throttling slightly
                    if (Math.abs(delta) > 10) {
                        if (delta > 0) tempFontSize += 0.1;
                        else tempFontSize = Math.max(1, tempFontSize - 0.1);
                        
                        sendData({ type: 'fontSize', val: tempFontSize });
                        pinchDistStart = dist; // Reset for continuous smooth zoom
                    }
                    return;
                }

                if (!isTouching) return;

                const currentY = e.touches[0].clientY;
                const deltaY = touchStartY - currentY; // Positive = Finger moved UP
                
                // Calculate Speed (Sensitivity)
                // Moving finger UP (positive delta) = Scroll speed positive (Text goes up)
                let scrollSpeed = deltaY * 0.15; 
                
                // Cap max speed
                if (scrollSpeed > 20) scrollSpeed = 20;
                if (scrollSpeed < -20) scrollSpeed = -20;

                sendData({ type: 'speed', val: scrollSpeed });

                // Update Visual Stick Head
                const rect = pad.getBoundingClientRect();
                const startRelY = touchStartY - rect.top;
                // Clamp visual movement
                let visualOffset = -deltaY; 
                stickHead.style.transform = `translate(-50%, calc(-50% + ${visualOffset}px))`;
            }, { passive: false });

            pad.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (e.touches.length === 0) {
                    isTouching = false;
                    sendData({ type: 'speed', val: 0 });
                    stickHead.style.display = 'none';
                    stickBase.style.display = 'none';
                    stickHead.style.transform = `translate(-50%, -50%)`;
                }
            });
        }

        // --- CONTROLLER UI FUNCTIONS ---
        function openEditor() {
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditor() {
            document.getElementById('editModal').style.display = 'none';
            const text = document.getElementById('fullTextInput').value;
            updateTextPreview();
            sendData({ type: 'text', val: text });
        }

        function updateTextPreview() {
            const text = document.getElementById('fullTextInput').value;
            const preview = text.split('\n')[0] || "No text...";
            document.getElementById('textPreview').innerText = preview;
        }

        function sendAction(actionType) {
            if (actionType === 'mirror') {
                const btn = document.getElementById('mirrorBtn');
                btn.classList.toggle('active');
            }
            sendData({ type: actionType });
        }

        function cycleColor() {
            sendData({ type: 'color' });
        }
        
        function toggleMirror() {
            sendAction('mirror');
        }

        // Prevent context menu on right click
        document.addEventListener('contextmenu', event => event.preventDefault());

    </script>
</body>
</html>
