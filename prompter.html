<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Prompter V2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        :root {
            --accent: #00ff88;
            --bg: #121212;
            --surface: #1e1e1e;
            --text: #ffffff;
            --pad-bg: #2a2a2a;
            --error: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        /* --- ICONS --- */
        .icon { width: 24px; height: 24px; fill: currentColor; pointer-events: none; }

        /* --- SETUP SCREEN --- */
        .setup {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            background: var(--bg);
            z-index: 1000;
            position: absolute;
            width: 100%;
            transition: opacity 0.3s;
        }

        .setup h1 { font-size: 2.5rem; letter-spacing: 5px; margin-bottom: 2rem; color: var(--accent); }
        
        .mode-select { display: flex; flex-direction: column; gap: 20px; align-items: center; width: 100%; max-width: 300px; }
        
        .big-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            width: 100%;
            text-align: center;
        }
        
        .big-btn:active { background: var(--accent); color: var(--bg); transform: scale(0.98); }

        .input-group {
            display: none; /* Hidden by default */
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        .code-input {
            background: var(--surface);
            border: 1px solid #444;
            color: #fff;
            padding: 15px;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 8px;
            letter-spacing: 5px;
            outline: none;
        }
        .code-input:focus { border-color: var(--accent); }

        .status { margin-top: 20px; color: #666; letter-spacing: 2px; font-size: 0.9rem; min-height: 20px; text-align: center;}
        .status.error { color: var(--error); }

        /* --- DISPLAY SCREEN --- */
        #displayView {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
        }

        #prompterContent {
            padding: 0 10vw;
            font-size: 5rem;
            line-height: 1.6;
            transform: translateY(45vh);
            will-change: transform;
            text-align: left;
            white-space: pre-wrap;
            font-weight: bold;
            transform-origin: center center;
        }

        .marker-line {
            position: fixed; top: 45%; left: 0; width: 100%; height: 0;
            border-top: 2px dashed rgba(255, 0, 0, 0.5); z-index: 50;
        }
        
        .triangle-marker {
            position: fixed; top: 45%; left: 20px; width: 0; height: 0;
            border-top: 15px solid transparent; border-bottom: 15px solid transparent;
            border-left: 20px solid rgba(255,0,0,0.7); transform: translateY(-50%);
        }

        .overlay-ui {
            position: fixed; top: 20px; right: 20px; z-index: 100;
            display: flex; gap: 10px; flex-direction: column; align-items: flex-end;
        }

        .room-code-display {
            background: rgba(0,0,0,0.7);
            color: var(--accent);
            padding: 10px;
            border-radius: 4px;
            border: 1px solid var(--accent);
            font-family: monospace;
            font-size: 1.2rem;
        }

        /* --- CONTROLLER SCREEN --- */
        #controllerView {
            display: none;
            flex-direction: column;
            height: 100%;
            background: var(--bg);
        }

        .top-bar {
            padding: 15px; background: var(--surface); display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #333;
        }

        .text-preview {
            flex: 1; background: #000; border: 1px solid #444; padding: 10px; color: #aaa; border-radius: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px;
        }

        .edit-btn {
            background: var(--accent); border: none; border-radius: 4px; width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center; color: #000; cursor: pointer;
        }

        .pad-container {
            flex-grow: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden;
        }

        #scrollPad {
            width: 90%; height: 90%; background: var(--pad-bg); border-radius: 12px; position: relative;
            display: flex; justify-content: center; align-items: center; flex-direction: column; border: 2px solid #444; touch-action: none;
        }

        .pad-instruction {
            color: rgba(255,255,255,0.2); font-weight: bold; text-align: center; pointer-events: none; line-height: 1.5;
        }

        #stickBase {
            position: absolute; width: 1px; height: 100%; background: rgba(255,255,255,0.1); display: none;
        }
        #stickHead {
            position: absolute; width: 80px; height: 80px; background: rgba(0, 255, 136, 0.2);
            border: 2px solid var(--accent); border-radius: 50%; transform: translate(-50%, -50%); display: none; pointer-events: none;
        }

        .bottom-toolbar {
            background: var(--surface); padding: 15px; display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; border-top: 1px solid #333;
        }

        .tool-btn {
            background: transparent; border: 1px solid #444; border-radius: 8px; height: 50px;
            display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer;
        }
        .tool-btn:active { background: #444; }
        .tool-btn.active { background: var(--accent); color: #000; border: none; }

        /* --- EDIT MODAL --- */
        #editModal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; flex-direction: column;
        }
        
        #editModal textarea {
            flex: 1; background: #121212; color: #fff; padding: 20px; font-size: 18px; border: none; resize: none; outline: none;
        }
        
        .modal-header {
            padding: 15px; background: var(--surface); display: flex; justify-content: space-between; align-items: center;
        }

        .save-btn {
            background: var(--accent); color: #000; padding: 8px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="setup" id="setupView">
        <h1>PROMPTER</h1>
        
        <div class="mode-select" id="initialBtns">
            <button class="big-btn" onclick="startDisplay()">I AM THE SCREEN</button>
            <button class="big-btn" onclick="showRemoteInput()">I AM THE REMOTE</button>
        </div>

        <div class="mode-select input-group" id="remoteInputGroup">
            <input type="number" id="roomCodeInput" class="code-input" placeholder="0000" pattern="\d*">
            <button class="big-btn" onclick="connectToDisplay()">CONNECT</button>
            <button class="big-btn" style="border-color: #444; color: #888; font-size: 0.9rem;" onclick="backToMain()">BACK</button>
        </div>

        <div class="status" id="statusText">Select Mode</div>
    </div>

    <div id="displayView">
        <div class="marker-line"></div>
        <div class="triangle-marker"></div>
        
        <div class="overlay-ui" id="displayUI">
            <div class="room-code-display" id="displayCodeBox">CODE: ----</div>
            <button class="big-btn" style="font-size: 0.8rem; padding: 8px;" onclick="toggleLocalFullscreen()">FULLSCREEN</button>
        </div>

        <div id="prompterContent">
            Waiting for connection...
            1. Open Prompter on phone
            2. Select 'I AM THE REMOTE'
            3. Enter code above
        </div>
    </div>

    <div id="controllerView">
        <div class="top-bar">
            <div class="text-preview" id="textPreview" onclick="openEditor()">Tap to edit script...</div>
            <button class="edit-btn" onclick="openEditor()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
            </button>
        </div>

        <div class="pad-container">
            <div id="scrollPad">
                <div class="pad-instruction">
                    TOUCH & HOLD TO SCROLL<br>
                    <span style="font-size:0.8em; font-weight:normal; opacity:0.7">PINCH TO RESIZE TEXT</span>
                </div>
                <div id="stickBase"></div>
                <div id="stickHead"></div>
            </div>
        </div>

        <div class="bottom-toolbar">
            <button class="tool-btn" onclick="sendAction('reset')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
            </button>
            
            <button class="tool-btn" onclick="toggleMirror()" id="mirrorBtn">
                <svg class="icon" viewBox="0 0 24 24"><path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/></svg>
            </button>

            <button class="tool-btn" onclick="sendAction('sync')" style="color: var(--accent)">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
            </button>
            
            <button class="tool-btn" onclick="cycleColor()">
                <svg class="icon" viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8z"/></svg>
            </button>

            <button class="tool-btn" onclick="sendAction('hideUI')">
                <svg class="icon" viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
            </button>
        </div>
    </div>

    <div id="editModal">
        <div class="modal-header">
            <span>Edit Script</span>
            <button class="save-btn" onclick="closeEditor()">DONE</button>
        </div>
        <textarea id="fullTextInput" placeholder="Type your text here...">Welcome to Pro Prompter.

This is a demonstration script.

1. Use the large pad on the Remote to scroll.
   - Slide UP to scroll down.
   - The further you slide, the faster it goes.
2. Pinch on the pad to change text size.
3. Tap "Edit" on the remote to change this text.

Happy Recording!</textarea>
    </div>

    <script>
        // --- CONSTANTS ---
        const ID_PREFIX = "PROMPTER-V2-";

        // --- GLOBAL STATE ---
        let peer, conn;
        let mode = ''; // 'display' or 'controller'
        let myRoomCode = '';
        let heartbeatInterval;
        let wakeLock = null;

        // Display State
        let scrollY = 0;
        let speed = 0;
        let isMirrored = false;
        let fontSize = 5; 
        let isUIHidden = false;

        // Controller State
        let touchStartY = 0;
        let isTouching = false;
        let pinchDistStart = 0;
        let tempFontSize = 5;

        // --- SETUP FUNCTIONS ---
        function setStatus(msg, isError = false) {
            const el = document.getElementById('statusText');
            el.innerText = msg;
            el.className = isError ? "status error" : "status";
        }

        function backToMain() {
            document.getElementById('initialBtns').style.display = 'flex';
            document.getElementById('remoteInputGroup').style.display = 'none';
            setStatus("Select Mode");
        }

        function showRemoteInput() {
            document.getElementById('initialBtns').style.display = 'none';
            document.getElementById('remoteInputGroup').style.display = 'flex';
            document.getElementById('roomCodeInput').focus();
            setStatus("Enter the code from the Display screen");
        }

        // --- WAKE LOCK (Prevent sleep) ---
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                    wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
                }
            } catch (err) {
                console.log(`${err.name}, ${err.message}`);
            }
        }

        // --- PEER JS: DISPLAY SIDE ---
        function startDisplay() {
            mode = 'display';
            setStatus("Starting Display...");
            requestWakeLock();
            
            // Generate Random 4-Digit Code
            myRoomCode = Math.floor(1000 + Math.random() * 9000).toString();
            const fullId = ID_PREFIX + myRoomCode;

            document.getElementById('setupView').style.display = 'none';
            document.getElementById('displayView').style.display = 'block';
            document.getElementById('displayCodeBox').innerText = "CODE: " + myRoomCode;

            // Init Peer
            peer = new Peer(fullId);
            
            peer.on('open', (id) => {
                console.log('Host ID:', id);
            });

            peer.on('connection', (c) => {
                // If we already have a connection, we can choose to replace it or allow multiple
                // For this logic, we'll allow the new one to take over.
                if(conn) { conn.close(); }
                
                conn = c;
                setStatus("Remote Connected!");
                
                conn.on('data', handleData);
                conn.on('close', () => {
                    setStatus("Remote Disconnected");
                    conn = null;
                });

                // Send current text to new controller immediately
                setTimeout(() => {
                    const currentText = document.getElementById('prompterContent').innerText;
                    if(conn && conn.open) conn.send({ type: 'syncText', text: currentText });
                }, 500);
            });

            peer.on('error', (err) => {
                // If ID is taken (rare with random 4 digits), try again automatically
                if (err.type === 'unavailable-id') {
                    startDisplay(); 
                } else {
                    alert("Network Error: " + err.type);
                }
            });

            requestAnimationFrame(displayLoop);
        }

        // --- PEER JS: CONTROLLER SIDE ---
        function connectToDisplay() {
            const inputVal = document.getElementById('roomCodeInput').value;
            if (inputVal.length < 4) {
                setStatus("Please enter the 4-digit code", true);
                return;
            }

            mode = 'controller';
            setStatus("Connecting...");
            requestWakeLock();
            
            const targetId = ID_PREFIX + inputVal;
            
            peer = new Peer(); // Let PeerJS assign a random ID for the remote

            peer.on('open', () => {
                conn = peer.connect(targetId, { reliable: true });
                setupConnectionHandlers();
            });

            peer.on('error', (err) => {
                setStatus("Error: " + err.type, true);
                if(err.type === 'peer-unavailable') {
                    setStatus("Display not found. Check code.", true);
                }
            });
        }

        function setupConnectionHandlers() {
            conn.on('open', () => {
                console.log("Connected to display");
                document.getElementById('setupView').style.display = 'none';
                document.getElementById('controllerView').style.display = 'flex';
                setupControllerEvents();
                sendAction('sync'); // Request text
                startHeartbeat();
            });

            conn.on('data', (data) => {
                if (data.type === 'syncText') {
                    document.getElementById('fullTextInput').value = data.text;
                    updateTextPreview();
                }
            });

            conn.on('close', () => {
                console.log("Connection lost");
                document.getElementById('textPreview').innerText = "DISCONNECTED - Reconnecting...";
                // Attempt Reconnect
                setTimeout(() => {
                   if(peer && !peer.destroyed) {
                        const targetId = conn.peer;
                        console.log("Reconnecting to " + targetId);
                        conn = peer.connect(targetId);
                        setupConnectionHandlers();
                   }
                }, 2000);
            });

            conn.on('error', (err) => console.error(err));
        }

        // --- HEARTBEAT SYSTEM ---
        // Keeps the connection alive by sending small data every few seconds
        function startHeartbeat() {
            if(heartbeatInterval) clearInterval(heartbeatInterval);
            heartbeatInterval = setInterval(() => {
                if(conn && conn.open) {
                    conn.send({ type: 'ping' });
                }
            }, 2000);
        }

        // --- DATA HANDLING ---
        function sendData(data) {
            if (conn && conn.open) {
                conn.send(data);
            }
        }

        function handleData(data) {
            const content = document.getElementById('prompterContent');
            
            switch(data.type) {
                case 'speed': speed = data.val; break;
                case 'text': 
                    content.innerText = data.val; 
                    scrollY = 0; 
                    break;
                case 'fontSize':
                    fontSize = data.val;
                    content.style.fontSize = fontSize + 'rem';
                    break;
                case 'reset':
                    scrollY = 0;
                    speed = 0;
                    break;
                case 'mirror':
                    isMirrored = !isMirrored;
                    updateTransform();
                    content.style.textAlign = isMirrored ? 'right' : 'left';
                    break;
                case 'color':
                    const colors = ['#ffffff', '#ffff00', '#00ff00', '#00ffff'];
                    let curr = colors.indexOf(content.style.color || '#ffffff');
                    content.style.color = colors[(curr + 1) % colors.length];
                    break;
                case 'hideUI':
                    isUIHidden = !isUIHidden;
                    const opacity = isUIHidden ? '0' : '1';
                    document.getElementById('displayUI').style.opacity = opacity;
                    document.querySelector('.marker-line').style.opacity = opacity;
                    document.querySelector('.triangle-marker').style.opacity = opacity;
                    document.body.style.cursor = isUIHidden ? 'none' : 'default';
                    break;
                case 'sync':
                    conn.send({ type: 'syncText', text: content.innerText });
                    break;
                case 'ping':
                    // Just keeping connection alive
                    break;
            }
        }

        // --- DISPLAY LOOP ---
        function displayLoop() {
            if (Math.abs(speed) > 0.1) {
                scrollY -= speed; 
            }
            updateTransform();
            requestAnimationFrame(displayLoop);
        }

        function updateTransform() {
            const content = document.getElementById('prompterContent');
            const scale = isMirrored ? 'scaleX(-1)' : 'scaleX(1)';
            content.style.transform = `${scale} translateY(${scrollY}px)`;
        }

        function toggleLocalFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // --- CONTROLLER INPUT LOGIC ---
        function setupControllerEvents() {
            const pad = document.getElementById('scrollPad');
            const stickHead = document.getElementById('stickHead');
            const stickBase = document.getElementById('stickBase');

            pad.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length === 2) {
                    isTouching = false;
                    pinchDistStart = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    return;
                }

                isTouching = true;
                touchStartY = e.touches[0].clientY;
                
                const rect = pad.getBoundingClientRect();
                const relativeY = e.touches[0].clientY - rect.top;
                
                stickBase.style.display = 'block';
                stickBase.style.top = relativeY + 'px';
                stickHead.style.display = 'block';
                stickHead.style.top = relativeY + 'px';
            }, { passive: false });

            pad.addEventListener('touchmove', (e) => {
                e.preventDefault();
                // Pinch Logic
                if (e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].pageX - e.touches[1].pageX,
                        e.touches[0].pageY - e.touches[1].pageY
                    );
                    const delta = dist - pinchDistStart;
                    if (Math.abs(delta) > 10) {
                        if (delta > 0) tempFontSize += 0.1;
                        else tempFontSize = Math.max(1, tempFontSize - 0.1);
                        sendData({ type: 'fontSize', val: tempFontSize });
                        pinchDistStart = dist;
                    }
                    return;
                }

                if (!isTouching) return;

                const currentY = e.touches[0].clientY;
                const deltaY = touchStartY - currentY;
                let scrollSpeed = deltaY * 0.15;
                
                if (scrollSpeed > 25) scrollSpeed = 25;
                if (scrollSpeed < -25) scrollSpeed = -25;

                sendData({ type: 'speed', val: scrollSpeed });

                // Visual Joystick
                let visualOffset = -deltaY; 
                if(visualOffset > 40) visualOffset = 40;
                if(visualOffset < -40) visualOffset = -40;
                stickHead.style.transform = `translate(-50%, calc(-50% + ${visualOffset}px))`;
            }, { passive: false });

            pad.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (e.touches.length === 0) {
                    isTouching = false;
                    sendData({ type: 'speed', val: 0 });
                    stickHead.style.display = 'none';
                    stickBase.style.display = 'none';
                    stickHead.style.transform = `translate(-50%, -50%)`;
                }
            });
        }

        // --- CONTROLLER UI ACTIONS ---
        function openEditor() { document.getElementById('editModal').style.display = 'flex'; }
        
        function closeEditor() {
            document.getElementById('editModal').style.display = 'none';
            const text = document.getElementById('fullTextInput').value;
            updateTextPreview();
            sendData({ type: 'text', val: text });
        }

        function updateTextPreview() {
            const text = document.getElementById('fullTextInput').value;
            const preview = text.split('\n')[0] || "No text...";
            document.getElementById('textPreview').innerText = preview;
        }

        function sendAction(actionType) {
            if (actionType === 'mirror') {
                document.getElementById('mirrorBtn').classList.toggle('active');
            }
            sendData({ type: actionType });
        }

        function cycleColor() { sendData({ type: 'color' }); }
        function toggleMirror() { sendAction('mirror'); }

        document.addEventListener('contextmenu', event => event.preventDefault());

        // Re-request wake lock on visibility change (tabs can lose it)
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                await requestWakeLock();
            }
        });

    </script>
</body>
</html>
