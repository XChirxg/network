<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local WiFi Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
        }
        .container {
            text-align: center;
            padding: 20px;
        }
        .setup {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        .buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }
        button {
            padding: 15px 40px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #gameCanvas {
            border: 4px solid white;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            display: none;
        }
        .controller {
            display: none;
            width: 100%;
            max-width: 500px;
        }
        .dpad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px auto;
            max-width: 300px;
        }
        .dpad-btn {
            width: 80px;
            height: 80px;
            font-size: 24px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .dpad-btn:active {
            transform: scale(0.95);
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            font-size: 18px;
        }
        .score {
            font-size: 36px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="setup" id="setup">
            <h1>ðŸŽ® Local WiFi Game</h1>
            <div class="buttons">
                <button onclick="startAsPC()">ðŸ’» PC/Display</button>
                <button onclick="startAsPhone()">ðŸ“± Phone/Controller</button>
            </div>
            <div class="status" id="status">Choose your device</div>
        </div>
        
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="controller" id="controller">
            <div class="score" id="score">Score: 0</div>
            <div class="dpad">
                <div></div>
                <button class="dpad-btn" onmousedown="sendControl('up')" ontouchstart="sendControl('up')">â–²</button>
                <div></div>
                <button class="dpad-btn" onmousedown="sendControl('left')" ontouchstart="sendControl('left')">â—€</button>
                <div></div>
                <button class="dpad-btn" onmousedown="sendControl('right')" ontouchstart="sendControl('right')">â–¶</button>
                <div></div>
                <button class="dpad-btn" onmousedown="sendControl('down')" ontouchstart="sendControl('down')">â–¼</button>
                <div></div>
            </div>
            <div class="status">Connected! Control the paddle</div>
        </div>
    </div>

    <script>
        const FIXED_ID = 'GAME2024';
        let peer;
        let connection;
        let isPC = false;
        let gameLoop;
        let connectionAttempts = 0;
        
        // Game state
        const game = {
            paddle: { x: 350, y: 550, width: 100, height: 20, speed: 15 },
            ball: { x: 400, y: 300, vx: 4, vy: 4, radius: 10 },
            score: 0
        };

        function startAsPC() {
            isPC = true;
            document.getElementById('status').textContent = 'Starting PC display...';
            
            peer = new Peer(FIXED_ID);
            
            peer.on('open', () => {
                document.getElementById('setup').style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                console.log('PC ready, waiting for controller...');
            });
            
            peer.on('connection', (conn) => {
                connection = conn;
                connection.on('data', (data) => {
                    handleControl(data);
                });
                connection.on('open', () => {
                    console.log('Controller connected!');
                    startGame();
                });
            });

            peer.on('error', (err) => {
                if (err.type === 'unavailable-id') {
                    document.getElementById('status').textContent = 'PC already running! Close other tabs.';
                } else {
                    document.getElementById('status').textContent = 'Connection error. Refresh and try again.';
                }
            });
        }

        function startAsPhone() {
            isPC = false;
            document.getElementById('status').textContent = 'Connecting to PC...';
            
            peer = new Peer();
            peer.on('open', () => {
                attemptConnection();
            });
        }

        function attemptConnection() {
            connection = peer.connect(FIXED_ID);
            
            connection.on('open', () => {
                document.getElementById('setup').style.display = 'none';
                document.getElementById('controller').style.display = 'block';
                console.log('Connected to PC!');
            });
            
            connection.on('data', (data) => {
                if (data.score !== undefined) {
                    document.getElementById('score').textContent = 'Score: ' + data.score;
                }
            });

            connection.on('error', (err) => {
                connectionAttempts++;
                if (connectionAttempts < 5) {
                    document.getElementById('status').textContent = 'Connecting... attempt ' + connectionAttempts;
                    setTimeout(attemptConnection, 1000);
                } else {
                    document.getElementById('status').textContent = 'Cannot find PC. Make sure PC is started first!';
                }
            });
        }

        function sendControl(direction) {
            if (connection && connection.open) {
                connection.send({ control: direction });
            }
        }

        function handleControl(data) {
            if (data.control) {
                switch(data.control) {
                    case 'left':
                        game.paddle.x = Math.max(0, game.paddle.x - game.paddle.speed);
                        break;
                    case 'right':
                        game.paddle.x = Math.min(800 - game.paddle.width, game.paddle.x + game.paddle.speed);
                        break;
                }
            }
        }

        function startGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            gameLoop = setInterval(() => {
                // Update ball position
                game.ball.x += game.ball.vx;
                game.ball.y += game.ball.vy;
                
                // Wall collision
                if (game.ball.x - game.ball.radius < 0 || game.ball.x + game.ball.radius > 800) {
                    game.ball.vx = -game.ball.vx;
                }
                if (game.ball.y - game.ball.radius < 0) {
                    game.ball.vy = -game.ball.vy;
                }
                
                // Paddle collision
                if (game.ball.y + game.ball.radius > game.paddle.y &&
                    game.ball.y - game.ball.radius < game.paddle.y + game.paddle.height &&
                    game.ball.x > game.paddle.x &&
                    game.ball.x < game.paddle.x + game.paddle.width) {
                    game.ball.vy = -Math.abs(game.ball.vy);
                    game.score++;
                    if (connection && connection.open) {
                        connection.send({ score: game.score });
                    }
                }
                
                // Ball out of bounds
                if (game.ball.y > 600) {
                    game.ball.x = 400;
                    game.ball.y = 300;
                    game.ball.vx = 4 * (Math.random() > 0.5 ? 1 : -1);
                    game.ball.vy = 4;
                    game.score = 0;
                    if (connection && connection.open) {
                        connection.send({ score: game.score });
                    }
                }
                
                // Draw
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, 800, 600);
                
                // Draw paddle
                ctx.fillStyle = '#f5576c';
                ctx.fillRect(game.paddle.x, game.paddle.y, game.paddle.width, game.paddle.height);
                
                // Draw ball
                ctx.fillStyle = '#f093fb';
                ctx.beginPath();
                ctx.arc(game.ball.x, game.ball.y, game.ball.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // Draw score
                ctx.fillStyle = 'white';
                ctx.font = '36px Arial';
                ctx.fillText('Score: ' + game.score, 20, 40);
                
            }, 1000 / 60);
        }
    </script>
</body>
</html>
