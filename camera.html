<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Security Camera System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.5.2/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #000; color: #fff; min-height: 100vh; }
        
        /* Header & Status */
        .header { background: #111; padding: 16px 24px; border-bottom: 1px solid #222; }
        .header h1 { font-size: 18px; font-weight: 600; }
        
        .status-bar { padding: 12px 24px; background: #0a0a0a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #1a1a1a; font-size: 13px; }
        .status-item { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; transition: background 0.3s; }
        .status-dot.active { background: #10b981; box-shadow: 0 0 8px #10b981; }
        .status-dot.error { background: #ef4444; }

        /* Setup Screen */
        .setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 100px); padding: 24px; }
        .setup-screen h2 { font-size: 24px; margin-bottom: 32px; }
        .mode-selector { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
        
        .mode-card { background: #111; border: 1px solid #222; border-radius: 12px; padding: 32px; cursor: pointer; text-align: center; width: 220px; transition: all 0.2s; }
        .mode-card:hover { border-color: #444; background: #161616; transform: translateY(-2px); }
        .mode-card h3 { font-size: 18px; margin: 12px 0 4px; }
        .mode-card p { color: #888; font-size: 13px; }
        .icon { font-size: 32px; margin-bottom: 8px; }

        /* Inputs */
        .input-group { margin-top: 16px; width: 100%; }
        .code-input { width: 100%; background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 6px; font-size: 16px; text-align: center; letter-spacing: 2px; margin-top: 8px; outline: none; }
        .code-input:focus { border-color: #666; }
        .join-btn { width: 100%; background: #fff; color: #000; border: none; padding: 12px; border-radius: 6px; font-weight: 600; margin-top: 12px; cursor: pointer; }
        .join-btn:active { opacity: 0.9; }

        /* Monitor View */
        .monitor-view, .camera-view { display: none; padding: 24px; }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .monitor-info { background: #1a1a1a; padding: 8px 16px; border-radius: 20px; border: 1px solid #333; font-size: 14px; }
        .monitor-code { color: #10b981; font-weight: 700; letter-spacing: 1px; }

        .camera-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; }
        .camera-card { background: #0a0a0a; border-radius: 8px; overflow: hidden; border: 1px solid #222; position: relative; }
        .camera-card.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; border: none; border-radius: 0; }
        
        .camera-header { background: rgba(0,0,0,0.8); padding: 12px; display: flex; justify-content: space-between; position: absolute; top: 0; left: 0; right: 0; z-index: 10; backdrop-filter: blur(4px); }
        .camera-video { width: 100%; aspect-ratio: 16/9; background: #000; display: block; object-fit: cover; }
        .camera-card.fullscreen .camera-video { height: 100vh; width: 100vw; object-fit: contain; }

        /* Camera View (Sender) */
        .camera-stream-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; max-width: 500px; margin: 0 auto; }
        .preview-container { width: 100%; position: relative; border-radius: 12px; overflow: hidden; border: 1px solid #333; }
        .preview-video { width: 100%; display: block; background: #000; }
        .status-badge { position: absolute; top: 12px; left: 12px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 12px; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(4px); }
        .blink-dot { width: 6px; height: 6px; background: #ef4444; border-radius: 50%; animation: blink 1s infinite; }
        
        .controls { display: flex; gap: 12px; width: 100%; }
        .control-btn { flex: 1; background: #222; border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 12px; }
        .control-btn:active { background: #333; }

        .empty-state { grid-column: 1 / -1; text-align: center; padding: 60px; color: #666; border: 2px dashed #222; border-radius: 12px; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        @media (max-width: 768px) { .camera-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>Security System</h1>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <div class="status-dot" id="connectionStatus"></div>
            <span id="statusText">Disconnected</span>
        </div>
        <div class="status-item" id="peerInfo" style="display:none">
            ID: <span id="myIdDisplay" style="font-family: monospace;">...</span>
        </div>
    </div>

    <div class="setup-screen" id="setupScreen">
        <h2>Select Mode</h2>
        <div class="mode-selector">
            <div class="mode-card" onclick="initMonitor()">
                <div class="icon">üñ•Ô∏è</div>
                <h3>Create Monitor</h3>
                <p>Use this device to view cameras</p>
            </div>

            <div class="mode-card" onclick="showCameraInput()">
                <div class="icon">üé•</div>
                <h3>Connect Camera</h3>
                <p>Use this device as a camera</p>
                
                <div id="cameraInputGroup" class="input-group" style="display: none;" onclick="event.stopPropagation()">
                    <input type="number" id="monitorCodeInput" class="code-input" placeholder="Enter Monitor Code">
                    <button class="join-btn" onclick="initCamera()">Start Streaming</button>
                </div>
            </div>
        </div>
    </div>

    <div class="monitor-view" id="monitorView">
        <div class="view-header">
            <h2>Live Feeds</h2>
            <div class="monitor-info">
                Monitor Code: <span class="monitor-code" id="displayCode">...</span>
            </div>
        </div>
        <div class="camera-grid" id="cameraGrid">
            <div class="empty-state">
                <h3>Waiting for connection...</h3>
                <p>Enter code <strong id="emptyStateCode" style="color:#fff">...</strong> on your camera device</p>
            </div>
        </div>
    </div>

    <div class="camera-view" id="cameraView">
        <div class="camera-stream-wrapper">
            <div class="preview-container">
                <video id="localVideo" class="preview-video" autoplay muted playsinline></video>
                <div class="status-badge">
                    <div class="blink-dot"></div>
                    <span>LIVE</span>
                </div>
            </div>
            
            <div class="controls">
                <button class="control-btn" onclick="switchCamera()">
                    <span>üîÑ</span> Switch Cam
                </button>
                <button class="control-btn" onclick="toggleMute()">
                    <span>üé§</span> Toggle Audio
                </button>
            </div>
            <p style="color: #666; font-size: 13px; text-align: center;">Connected to Monitor</p>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const PEER_CONFIG = {
            debug: 2,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        // --- Global Variables ---
        let peer = null;
        let localStream = null;
        let currentFacingMode = 'environment';
        let isMonitor = false;

        // --- Utils ---
        function generateShortId() {
            // Generate a random 6-digit number
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function updateStatus(active, text) {
            const dot = document.getElementById('connectionStatus');
            const txt = document.getElementById('statusText');
            dot.className = active ? 'status-dot active' : 'status-dot error';
            txt.textContent = text;
        }

        // --- Monitor Logic ---
        function initMonitor() {
            isMonitor = true;
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('monitorView').style.display = 'block';

            // 1. Generate a Code
            const code = generateShortId();
            const peerId = 'scam-mon-' + code;

            // 2. Display Code to User
            document.getElementById('displayCode').textContent = code;
            document.getElementById('emptyStateCode').textContent = code;

            // 3. Initialize Peer
            peer = new Peer(peerId, PEER_CONFIG);

            peer.on('open', (id) => {
                console.log('Monitor ID:', id);
                updateStatus(true, 'Monitor Active');
            });

            peer.on('call', (call) => {
                console.log('Incoming call...');
                call.answer(); // Answer automatically
                call.on('stream', (remoteStream) => {
                    addCameraFeed(call.peer, remoteStream);
                });
                call.on('close', () => removeCameraFeed(call.peer));
            });

            peer.on('error', (err) => {
                console.error(err);
                if (err.type === 'unavailable-id') {
                    alert('ID Collision. Please reload.');
                } else {
                    updateStatus(false, 'Error: ' + err.type);
                }
            });
        }

        function addCameraFeed(peerId, stream) {
            const grid = document.getElementById('cameraGrid');
            
            // Remove empty state if exists
            const empty = grid.querySelector('.empty-state');
            if(empty) empty.style.display = 'none';

            // Check if already exists
            if (document.getElementById('cam-' + peerId)) return;

            const card = document.createElement('div');
            card.className = 'camera-card';
            card.id = 'cam-' + peerId;
            
            card.innerHTML = `
                <div class="camera-header">
                    <span>üé• Remote Camera</span>
                    <button style="background:none;border:none;color:white;cursor:pointer" onclick="toggleFull('${peerId}')">‚õ∂</button>
                </div>
                <video class="camera-video" autoplay playsinline></video>
            `;

            grid.appendChild(card);
            
            const video = card.querySelector('video');
            video.srcObject = stream;
        }

        function removeCameraFeed(peerId) {
            const card = document.getElementById('cam-' + peerId);
            if (card) card.remove();
            
            const grid = document.getElementById('cameraGrid');
            if (grid.children.length === 1) { // Only empty state remains (hidden)
                grid.querySelector('.empty-state').style.display = 'block';
            }
        }

        function toggleFull(id) {
            const el = document.getElementById('cam-' + 'scam-mon-' + id) || document.getElementById('cam-' + id);
            if(el) el.classList.toggle('fullscreen');
        }

        // --- Camera Logic ---
        function showCameraInput() {
            document.getElementById('cameraInputGroup').style.display = 'block';
        }

        async function initCamera() {
            const code = document.getElementById('monitorCodeInput').value;
            if (!code || code.length < 6) {
                alert('Please enter the 6-digit Monitor Code shown on the other device.');
                return;
            }

            // 1. Setup UI
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('cameraView').style.display = 'block';

            // 2. Start Camera
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode, width: 1280, height: 720 },
                    audio: true
                });
                document.getElementById('localVideo').srcObject = localStream;
            } catch (err) {
                alert('Camera access denied: ' + err.message);
                return;
            }

            // 3. Connect to Monitor
            const monitorId = 'scam-mon-' + code;
            const myId = 'scam-cam-' + generateShortId();
            
            peer = new Peer(myId, PEER_CONFIG);

            peer.on('open', (id) => {
                updateStatus(true, 'Connecting to Monitor...');
                const call = peer.call(monitorId, localStream);
                
                call.on('close', () => {
                    updateStatus(false, 'Monitor Disconnected');
                    alert('Monitor disconnected');
                    location.reload();
                });

                call.on('error', (err) => {
                    console.error(err);
                    updateStatus(false, 'Call Failed');
                });
                
                // Monitor the connection state
                const conn = peer.connect(monitorId);
                conn.on('open', () => {
                    updateStatus(true, 'Connected & Streaming');
                });
            });

            peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'peer-unavailable') {
                    alert('Monitor not found! Check the code and try again.');
                    location.reload();
                } else {
                    updateStatus(false, 'Connection Error');
                }
            });
        }

        // --- Camera Controls ---
        async function switchCamera() {
            if (!localStream) return;
            
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            
            // Stop current tracks
            localStream.getTracks().forEach(track => track.stop());
            
            // Restart with new facing mode
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: currentFacingMode },
                    audio: true
                });
                
                // Update local video
                document.getElementById('localVideo').srcObject = localStream;
                
                // Note: PeerJS ReplaceTrack is complex, easiest way for this simple app 
                // is to just rejoin or let the user know they need to refresh to send new stream.
                // For now, we update local preview. To update remote, we'd need to re-call.
                // Simple re-call logic:
                const code = document.getElementById('monitorCodeInput').value;
                const monitorId = 'scam-mon-' + code;
                peer.call(monitorId, localStream);

            } catch (err) {
                console.error(err);
            }
        }

        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    alert(audioTrack.enabled ? 'Microphone Unmuted' : 'Microphone Muted');
                }
            }
        }

        // Keep screen awake (hack)
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(console.error);
        }
    </script>
</body>
</html>
